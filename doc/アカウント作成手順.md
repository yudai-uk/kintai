# 開発者アカウント作成手順

このドキュメントはローカル開発環境でログイン検証を行うための「開発者アカウント」の作成手順をまとめたものです。

## 前提
- Supabase ローカルが起動済み（`supabase start`）
- 一括起動スクリプトで各サービスを起動（例: ルートで `npm run dev`）
- 環境変数の設定が完了していること
  - `frontend/.env.local`
    - `NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321`
    - `NEXT_PUBLIC_SUPABASE_ANON_KEY=<supabase status の anon key>`
  - `backend/.env`
    - `DATABASE_URL=postgresql://postgres:postgres@127.0.0.1:54322/postgres`
    - `SUPABASE_JWT_SECRET=<supabase status の JWT secret>`

参考（Supabaseローカルの主なURL）
- API URL: `http://127.0.0.1:54321`
- Studio: `http://127.0.0.1:54323`
- DB: `postgresql://postgres:postgres@127.0.0.1:54322/postgres`

## 1. Supabase Studio でユーザー作成
1) Studio を開く: `http://127.0.0.1:54323`
2) 左メニュー「Authentication → Users」へ移動
3) 「Add user」をクリックし、以下を入力
   - Email: 開発者用メール（例: `dev@example.com`）
   - Password: 任意の強固なパスワード
   - Email confirmed: 有効（ローカルは確認不要設定）
4) 「Create」で作成

## 2. ログインと自動プロビジョニング
1) ブラウザで `http://localhost:3000/login` を開く
2) 上記で作成した Email / Password でサインイン
3) 保護ページへアクセス（例: `http://localhost:3000/employee`）
   - 初回アクセス時、バックエンドが Supabase の `sub`（ユーザーUID）を用いて `public.users` にユーザーを自動登録します（`role=employee`）。

## 3. 管理者権限の付与（任意）
- Studio の Table editor で `public.users` を開き、対象ユーザー行の `role` を `admin` に変更して保存
- SQL で更新する場合（Studio → SQL Editor）：
```sql
update users set role = 'admin' where email = 'dev@example.com';
```

## 4. 動作確認
- ログイン後、`http://localhost:3000/employee` を開く
  - 200 が返り、勤怠データ取得が表示されればOK（バックエンドは JWT を検証）
- 401/403 の場合は以下を確認
  - フロントのリクエストに `Authorization: Bearer <access_token>` が付与されているか
    - `apiClient.get(url, { auth: true })` を使用すると自動付与されます
  - `backend/.env` の `SUPABASE_JWT_SECRET` が Supabase の「JWT secret」と一致しているか
  - `public.users.role` が期待どおりか（管理系は `admin`/`manager`）

## 5. トラブルシューティング
- 環境変数を変更したのに反映されない
  - Next.js / Go の開発サーバーを再起動してください（起動時に読み込みます）
- Supabase が起動しない / ポート占有
  - `supabase stop` → 古いコンテナを削除 → `supabase start` を再実行
- JWT 検証エラー（常に 401）
  - `SUPABASE_JWT_SECRET` の不一致が多い原因です。`supabase status` の「JWT secret」を `backend/.env` に設定してください。

## 参考（構成方針）
- 認証は Supabase が担当（メール+パスワード、JWT発行）
- フロント（Next.js）は `@supabase/ssr` と Middleware でセッション管理
- バックエンド（Go/Echo）は受け取った JWT の検証のみを実施し、DB の `users` と紐付けて認可を行います
